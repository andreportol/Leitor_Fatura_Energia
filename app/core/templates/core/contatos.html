{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração de Contatos | ALP SISTEMAS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-md navbar-light bg-white shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2" href="{% url 'core:index' %}">
                <img src="{% static 'img/logomarca.png' %}" alt="Logo ALP SISTEMAS" class="brand-logo me-2 d-none d-md-inline-block">
                <div class="d-flex flex-column lh-1">
                    <div class="d-flex align-items-center">
                        <span class="brand-color">ALP</span>
                        <span class="ms-1">SISTEMAS</span>
                    </div>
                    {% if cliente %}<span class="text-muted fs-6">Cliente VIP: {{ cliente.nome }}</span>{% endif %}
                </div>
            </a>
            <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu" aria-controls="navbarMenu" aria-expanded="false" aria-label="Alternar navegação">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarMenu">
                <ul class="navbar-nav align-items-md-center ms-auto gap-md-3">
                    <li class="nav-item">
                        <a class="nav-link px-0 text-secondary fw-semibold" href="{% url 'core:processamento' %}">
                            <i class="fas fa-arrow-left me-2"></i>Voltar ao processamento
                        </a>
                    </li>
                    <li class="nav-item">
                        <form method="post" action="{% url 'core:logout' %}" class="mb-0">
                            {% csrf_token %}
                            <a href="#" class="nav-link px-0 text-danger fw-semibold d-inline-flex align-items-center gap-2" onclick="this.closest('form').submit(); return false;">
                                <i class="fas fa-right-from-bracket"></i>Sair
                            </a>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="py-5">
        <div class="container">
            {% if messages %}
            <div class="row justify-content-center mb-3">
                <div class="col-lg-10">
                    {% for message in messages %}
                        <div class="alert alert-{% if 'error' in message.tags %}danger{% else %}{{ message.tags|default:'info' }}{% endif %} mb-2" role="alert">{{ message }}</div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="card shadow border-2 border-primary-subtle rounded-4 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-3 text-primary"><i class="fas fa-user-plus fa-lg"></i></div>
                                <div>
                                    <p class="text-uppercase text-primary fw-semibold mb-1 small">Novo contato</p>
                                    <h2 class="h5 mb-0">Cadastrar destinatário</h2>
                                </div>
                            </div>
                            <form method="post" action="{% url 'core:contatos' %}" class="row g-3">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="save_contact">
                                <div class="col-12">
                                    <label class="form-label">Nome</label>
                                    <input type="text" name="contact_name" class="form-control" required placeholder="Ex.: João da Silva">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">E-mail</label>
                                    <input type="email" name="contact_email" class="form-control" placeholder="contato@email.com">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Telefone (WhatsApp)</label>
                                    <input type="text" name="contact_phone" class="form-control" placeholder="(67) 99999-9999">
                                </div>
                                <div class="col-12 d-grid">
                                    <button type="submit" class="btn btn-primary text-white">
                                        <i class="fas fa-save me-2"></i>Salvar contato
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="card shadow border-2 border-secondary-subtle rounded-4 h-100">
                        <div class="card-body p-4 d-flex flex-column">
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-3 text-secondary"><i class="fas fa-rectangle-list fa-lg"></i></div>
                                <div>
                                    <p class="text-uppercase text-secondary fw-semibold mb-1 small">Lista de contatos</p>
                                    <h2 class="h5 mb-0">Gerencie destinatários</h2>
                                </div>
                            </div>
                            <form id="searchForm" method="get" action="{% url 'core:contatos' %}" class="d-flex align-items-center gap-2 mb-3">
                                <input id="contactSearchInput" type="text" name="contact_q" class="form-control form-control-sm" placeholder="Buscar por nome ou e-mail" value="{{ contact_search }}">
                                <button type="submit" class="btn btn-outline-secondary btn-sm"><i class="fas fa-search"></i></button>
                            </form>
                            <div class="text-muted small mb-2">
                                Mostrando {{ contatos|length }} de {{ contacts_total }} contato(s){% if contact_search %} filtrados{% endif %}.
                            </div>
                            <div class="flex-grow-1">
                                {% if contatos %}
                                    <ul class="list-group list-group-flush">
                                        {% for contato in contatos %}
                                        <li class="list-group-item d-flex flex-column gap-2">
                                            <div>
                                                <div class="fw-semibold">{{ contato.nome }}</div>
                                                <div class="text-muted small">
                                                    {% if contato.email %}<i class="fas fa-envelope me-1"></i>{{ contato.email }}{% else %}Sem e-mail{% endif %}
                                                    {% if contato.telefone %} · <i class="fab fa-whatsapp me-1"></i>{{ contato.telefone }}{% endif %}
                                                </div>
                                            </div>
                                            <div class="d-flex flex-column gap-2">
                                                <form id="save-contact-{{ contato.id }}" method="post" action="{% url 'core:contatos' %}" class="d-flex flex-column gap-2 w-100 mb-0">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="save_contact">
                                                    <input type="hidden" name="contact_id" value="{{ contato.id }}">
                                                    <input type="text" name="contact_name" class="form-control form-control-sm" value="{{ contato.nome }}" placeholder="Nome">
                                                    <input type="email" name="contact_email" class="form-control form-control-sm" value="{{ contato.email }}" placeholder="E-mail">
                                                    <input type="text" name="contact_phone" class="form-control form-control-sm" value="{{ contato.telefone }}" placeholder="Telefone">
                                                </form>
                                                <div class="d-flex gap-2 align-items-center">
                                                    <button type="submit" form="save-contact-{{ contato.id }}" class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-save"></i>
                                                    </button>
                                                    <form method="post" action="{% url 'core:contatos' %}" class="mb-0">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="action" value="delete_contact">
                                                        <input type="hidden" name="contact_id" value="{{ contato.id }}">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% if page_obj and page_obj.paginator.num_pages > 1 %}
                                    <nav class="mt-3">
                                        <ul class="pagination pagination-sm mb-0">
                                            {% if page_obj.has_previous %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if contact_search %}&contact_q={{ contact_search }}{% endif %}">&laquo;</a>
                                                </li>
                                            {% else %}
                                                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                                            {% endif %}
                                            {% for num in page_obj.paginator.page_range %}
                                                {% if page_obj.number == num %}
                                                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                                {% else %}
                                                    <li class="page-item"><a class="page-link" href="?page={{ num }}{% if contact_search %}&contact_q={{ contact_search }}{% endif %}">{{ num }}</a></li>
                                                {% endif %}
                                            {% endfor %}
                                            {% if page_obj.has_next %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if contact_search %}&contact_q={{ contact_search }}{% endif %}">&raquo;</a>
                                                </li>
                                            {% else %}
                                                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                                            {% endif %}
                                        </ul>
                                    </nav>
                                    {% endif %}
                                {% else %}
                                    {% if contact_search %}
                                        <p class="text-muted small mb-0">Nenhum contato encontrado para a busca.</p>
                                    {% else %}
                                        <p class="text-muted small mb-0">Nenhum contato cadastrado ainda.</p>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    {% include 'core/partials/admin_shortcut.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (() => {
            const input = document.getElementById('contactSearchInput');
            const form = document.getElementById('searchForm');
            if (!input || !form) return;
            let timer = null;
            input.addEventListener('input', () => {
                clearTimeout(timer);
                timer = setTimeout(() => form.submit(), 400);
            });
        })();
    </script>
</body>
</html>
